<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Thrift by Example &mdash; Thrift Tutorial 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Thrift Tutorial 1.0 documentation" href="index.html" />
    <link rel="next" title="Thrift’s auto-generated code for the multiplication service example" href="multiplication-service.html" />
    <link rel="prev" title="Writing a .thrift file" href="thrift-file.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="multiplication-service.html" title="Thrift’s auto-generated code for the multiplication service example"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="thrift-file.html" title="Writing a .thrift file"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Thrift Tutorial 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="thrift-by-example">
<h1>Thrift by Example<a class="headerlink" href="#thrift-by-example" title="Permalink to this headline">¶</a></h1>
<div class="section" id="generating-code-with-thrift">
<h2>Generating code with Thrift<a class="headerlink" href="#generating-code-with-thrift" title="Permalink to this headline">¶</a></h2>
<p>After creating a .thrift file (See <a class="reference internal" href="thrift-file.html"><em>Writing a .thrift file</em></a>) you are now ready to run Thrift in order to generate code in your targeted languages. The usage of thrift command is:</p>
<div class="highlight-python"><pre>thrift [options] file</pre>
</div>
<p>For example if you want to generate code for java you should type:</p>
<div class="highlight-python"><pre>thrift -r --gen filame.thrift</pre>
</div>
<p>The above command will generate a directory gen-java which will contain all the code generated by Thrift in java. The option -r is to specify that I want to generate recursively code for potential includes on our .thrift file.
After generating code you are now ready to create your client and server code and use the Thrift generated code to do the hard work for you, as you will se below.</p>
<p><tt class="docutils literal"><span class="pre">Notice:</span> <span class="pre">When</span> <span class="pre">trying</span> <span class="pre">to</span> <span class="pre">run</span> <span class="pre">the</span> <span class="pre">python</span> <span class="pre">server</span> <span class="pre">you</span> <span class="pre">may</span> <span class="pre">encounter</span> <span class="pre">the</span> <span class="pre">error:</span></tt></p>
<div class="highlight-python"><pre>ImportError: No module named Thrift</pre>
</div>
<p><tt class="docutils literal"><span class="pre">This</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">easily</span> <span class="pre">fixed</span> <span class="pre">by</span> <span class="pre">going</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">directory</span> <span class="pre">lib/py</span> <span class="pre">on</span> <span class="pre">the</span> <span class="pre">thrift</span> <span class="pre">installation</span> <span class="pre">directory</span> <span class="pre">and</span> <span class="pre">run</span> <span class="pre">the</span> <span class="pre">following</span> <span class="pre">command</span> <span class="pre">to</span> <span class="pre">install</span> <span class="pre">the</span> <span class="pre">thrift</span> <span class="pre">module</span> <span class="pre">to</span> <span class="pre">your</span> <span class="pre">python</span> <span class="pre">libraries:</span></tt></p>
<div class="highlight-python"><pre>sudo python setup.py install</pre>
</div>
</div>
<div class="section" id="a-simple-example-to-warm-up">
<h2>A Simple Example to warm-up<a class="headerlink" href="#a-simple-example-to-warm-up" title="Permalink to this headline">¶</a></h2>
<p>On this example I will demonstrate the creation of a simple multiplication service.</p>
<ul>
<li><p class="first">Lets create first the .thrift definition of our service. The .thrift file I am going to use is the same you saw in the <a class="reference internal" href="thrift-file.html"><em>Writing a .thrift file</em></a> and is as shown below:</p>
<div class="highlight-python"><pre>namespace java tutorial
namespace py tutorial

typedef i32 int // We can use typedef to get pretty names for the types we are using
service MultiplicationService
{
        int multiply(1:int n1, 2:int n2),
}</pre>
</div>
</li>
<li><p class="first">Name this file multiple.thrift and then run the below commands to generate code for java and python</p>
<div class="highlight-python"><pre>thrift --gen java multiplication.thrift
thrift --gen py multiplication.thrift</pre>
</div>
</li>
</ul>
<p>After running the commands Thrift should generate code inside the directories gen-java/tutorial and gen-py/tutorial for Java and Python respectively.
<tt class="docutils literal"><span class="pre">Remember</span> <span class="pre">to</span> <span class="pre">use</span> <span class="pre">sudo</span> <span class="pre">in</span> <span class="pre">case</span> <span class="pre">the</span> <span class="pre">directories</span> <span class="pre">are</span> <span class="pre">not</span> <span class="pre">created!</span></tt>
It would be useful to take a look on this code to get a better understanding of what code Thrift generates for you.
You can find a short explanation of the code here: <a class="reference internal" href="multiplication-service.html"><em>Thrift&#8217;s auto-generated code for the multiplication service example</em></a></p>
<ul class="simple">
<li>Now we are ready to write our own code. Lets first write some Java code for our client and server and then we will also write a Python client to send requests to our server. We will not need to change anything on the server part to do this!</li>
</ul>
<div class="section" id="multiplication-handler">
<h3>Multiplication Handler<a class="headerlink" href="#multiplication-handler" title="Permalink to this headline">¶</a></h3>
<p>Here is the MultiplicationHandler class in which I implement the interface specified before in our multi.thrift definition and for which Thrift had already generated code.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">org.apache.thrift.TException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiplicationHandler</span> <span class="kd">implements</span> <span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Iface</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	 <span class="kd">public</span> <span class="kt">int</span> <span class="nf">multiply</span><span class="o">(</span><span class="kt">int</span> <span class="n">n1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TException</span> <span class="o">{</span>
	    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Multiply(&quot;</span> <span class="o">+</span> <span class="n">n1</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">);</span>
	    <span class="k">return</span> <span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="o">;</span>
	 <span class="o">}</span>

	
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="java-multiplication-server">
<h3>Java Multiplication Server<a class="headerlink" href="#java-multiplication-server" title="Permalink to this headline">¶</a></h3>
<p>Here is the MultiplicationServer class in which I have implemented a simple server. With slightly different configuration this server can become secure as you will see in the next example.
The only thing worth messioning about the server implementation is the usage of the Processor class that is auto-generated by Thrift. The Processor does two simple things. Reads data from an input stream and writes data to an output stream. The processor reads data from the input, processes the data (actually uses the handler specified by the user to process the data) and the writes the processed data to the output. Finally, I should mention that for this example I used the simple server implemention, but it would be as easy to use any of the implementations offered by thrift (threadPoolServer or nonBlockingServer).</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">org.apache.thrift.server.TServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.server.TServer.Args</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.server.TSimpleServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TServerTransport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiplicationServer</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">MultiplicationHandler</span> <span class="n">handler</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Processor</span> <span class="n">processor</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultiplicationHandler</span><span class="o">();</span>
      <span class="n">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Processor</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>

      <span class="n">Runnable</span> <span class="n">simple</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">simple</span><span class="o">(</span><span class="n">processor</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">};</span>      
     
      <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">simple</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">x</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">simple</span><span class="o">(</span><span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Processor</span> <span class="n">processor</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">TServerTransport</span> <span class="n">serverTransport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TServerSocket</span><span class="o">(</span><span class="mi">9090</span><span class="o">);</span>
      <span class="n">TServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSimpleServer</span><span class="o">(</span><span class="k">new</span> <span class="n">Args</span><span class="o">(</span><span class="n">serverTransport</span><span class="o">).</span><span class="na">processor</span><span class="o">(</span><span class="n">processor</span><span class="o">));</span>

      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Starting the simple server...&quot;</span><span class="o">);</span>
      <span class="n">server</span><span class="o">.</span><span class="na">serve</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
 
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="java-multiplication-client">
<h3>Java Multiplication Client<a class="headerlink" href="#java-multiplication-client" title="Permalink to this headline">¶</a></h3>
<p>Importand things to notice on the client code is the use of the TBinaryProtocol for the serializitaion and deserialization part. I could also use the compact, the JSON protocol or any other protocol supported by thrift. For more details on the protocols you can use please refer to the <a class="reference internal" href="thrift-stack.html"><em>Thrift protocol stack</em></a> section of this tutorial.
Another importand thing to notice is the use of the client and the coresponding client.multiply() method provided to us by the auto-generated thrift code. This call behind the scenes calls the TServiceClient.sendBase() method that will write the data to the wire.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">org.apache.thrift.TException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.protocol.TBinaryProtocol</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.protocol.TProtocol</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TTransport</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiplicationClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

   
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">TTransport</span> <span class="n">transport</span><span class="o">;</span>
     
      <span class="n">transport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSocket</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">9090</span><span class="o">);</span>
      <span class="n">transport</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>

      <span class="n">TProtocol</span> <span class="n">protocol</span> <span class="o">=</span> <span class="k">new</span>  <span class="n">TBinaryProtocol</span><span class="o">(</span><span class="n">transport</span><span class="o">);</span>
      <span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Client</span><span class="o">(</span><span class="n">protocol</span><span class="o">);</span>

      <span class="n">perform</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>

      <span class="n">transport</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">x</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> 
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">perform</span><span class="o">(</span><span class="n">MultiplicationService</span><span class="o">.</span><span class="na">Client</span> <span class="n">client</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TException</span>
  <span class="o">{</span>
   
    <span class="kt">int</span> <span class="n">product</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;3*5=&quot;</span> <span class="o">+</span> <span class="n">product</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="python-multiplication-client">
<h3>Python Multiplication Client<a class="headerlink" href="#python-multiplication-client" title="Permalink to this headline">¶</a></h3>
<p>The python client implements anything as discussed for the java client. The language syntax is the only thing I had to change on my approach.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;../gen-py&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">tutorial</span> <span class="kn">import</span> <span class="n">MultiplicationService</span>
<span class="kn">from</span> <span class="nn">tutorial.ttypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">thrift</span> <span class="kn">import</span> <span class="n">Thrift</span>
<span class="kn">from</span> <span class="nn">thrift.transport</span> <span class="kn">import</span> <span class="n">TSocket</span>
<span class="kn">from</span> <span class="nn">thrift.transport</span> <span class="kn">import</span> <span class="n">TTransport</span>
<span class="kn">from</span> <span class="nn">thrift.protocol</span> <span class="kn">import</span> <span class="n">TBinaryProtocol</span>

<span class="k">try</span><span class="p">:</span>

  <span class="c"># Make socket</span>
  <span class="n">transport</span> <span class="o">=</span> <span class="n">TSocket</span><span class="o">.</span><span class="n">TSocket</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">9090</span><span class="p">)</span>

  <span class="c"># Buffering is critical. Raw sockets are very slow</span>
  <span class="n">transport</span> <span class="o">=</span> <span class="n">TTransport</span><span class="o">.</span><span class="n">TBufferedTransport</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

  <span class="c"># Wrap in a protocol</span>
  <span class="n">protocol</span> <span class="o">=</span> <span class="n">TBinaryProtocol</span><span class="o">.</span><span class="n">TBinaryProtocol</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>

  <span class="c"># Create a client to use the protocol encoder</span>
  <span class="n">client</span> <span class="o">=</span> <span class="n">MultiplicationService</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>

  <span class="c"># Connect!</span>
  <span class="n">transport</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

  <span class="n">product</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">&#39;4*5=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">product</span><span class="p">)</span>

  <span class="c"># Close!</span>
  <span class="n">transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">except</span> <span class="n">Thrift</span><span class="o">.</span><span class="n">TException</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="a-more-complicated-example">
<h2>A More Complicated Example<a class="headerlink" href="#a-more-complicated-example" title="Permalink to this headline">¶</a></h2>
<p>Now you are ready to see something a little bit more complicated. The bellow example describes the Thrift tutorial code included in the Thrift installation directory. The .thrift file for the calculator service provided on the Thrift installation, also servers the role of a short Thrift documentation. For this reason, I have deleted part of the comments on the file to avoid repeating things that I have already discussed. Follow the comments to understand how you can use thrift to generate code for more complicated services. Notice that this time code will be generated by Thrift not only for the Calculator but also for the exception, the enum Operation, the tutorialConstants and the struct Work. Of course the code for those files is much simpler as expected.</p>
<blockquote>
<div><div class="highlight-c"><pre>
include "shared.thrift"

namespace cpp tutorial
namespace d tutorial
namespace java tutorial
namespace php tutorial
namespace perl tutorial

/**
 * Thrift also lets you define constants for use across languages. Complex
 * types and structs are specified using JSON notation.
 */
const i32 INT32CONSTANT = 9853
const map&lt;string,string&gt; MAPCONSTANT = {'hello':'world', 'goodnight':'moon'}

/**
 * You can define enums, which are just 32 bit integers. Values are optional
 * and start at 1 if not supplied, C style again.
 */
enum Operation {
  ADD = 1,
  SUBTRACT = 2,
  MULTIPLY = 3,
  DIVIDE = 4
}

/**
 * Structs are the basic complex data structures. They are comprised of fields
 * which each have an integer identifier, a type, a symbolic name, and an
 * optional default value.
 *
 * Fields can be declared "optional", which ensures they will not be included
 * in the serialized output if they aren't set.  Note that this requires some
 * manual management in some languages.
 */
struct Work {
  1: i32 num1 = 0,
  2: i32 num2,
  3: Operation op,
  4: optional string comment,
}

/**
 * Structs can also be exceptions, if they are nasty.
 */
exception InvalidOperation {
  1: i32 what,
  2: string why
}

/**
 * Ahh, now onto the cool part, defining a service. Services just need a name
 * and can optionally inherit from another service using the extends keyword.
 */
service Calculator extends shared.SharedService {

  /**
   * A method definition looks like C code. It has a return type, arguments,
   * and optionally a list of exceptions that it may throw. Note that argument
   * lists and exception lists are specified using the exact same syntax as
   * field lists in struct or exception definitions.
   */

   void ping(),

   i32 add(1:i32 num1, 2:i32 num2),

   i32 calculate(1:i32 logid, 2:Work w) throws (1:InvalidOperation ouch),

   /**
    * This method has a oneway modifier. That means the client only makes
    * a request and does not listen for any response at all. Oneway methods
    * must be void.
    */
   oneway void zip()

}
</pre>
</div>
</div></blockquote>
<div class="section" id="calculator-service-handler">
<h3>Calculator Service Handler<a class="headerlink" href="#calculator-service-handler" title="Permalink to this headline">¶</a></h3>
<p>Nothing really changed here compared to the simple example you just saw. There are just more method interfaces implemented.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="cm"> * or more contributor license agreements. See the NOTICE file</span>
<span class="cm"> * distributed with this work for additional information</span>
<span class="cm"> * regarding copyright ownership. The ASF licenses this file</span>
<span class="cm"> * to you under the Apache License, Version 2.0 (the</span>
<span class="cm"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span class="cm"> * with the License. You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing,</span>
<span class="cm"> * software distributed under the License is distributed on an</span>
<span class="cm"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="cm"> * KIND, either express or implied. See the License for the</span>
<span class="cm"> * specific language governing permissions and limitations</span>
<span class="cm"> * under the License.</span>
<span class="cm"> */</span>

<span class="kn">import</span> <span class="nn">org.apache.thrift.TException</span><span class="o">;</span>

<span class="c1">// Generated code</span>
<span class="kn">import</span> <span class="nn">tutorial.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">shared.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CalculatorHandler</span> <span class="kd">implements</span> <span class="n">Calculator</span><span class="o">.</span><span class="na">Iface</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">SharedStruct</span><span class="o">&gt;</span> <span class="n">log</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">CalculatorHandler</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">SharedStruct</span><span class="o">&gt;();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">ping</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;ping()&quot;</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">n1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n2</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;add(&quot;</span> <span class="o">+</span> <span class="n">n1</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">n2</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">calculate</span><span class="o">(</span><span class="kt">int</span> <span class="n">logid</span><span class="o">,</span> <span class="n">Work</span> <span class="n">work</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidOperation</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;calculate(&quot;</span> <span class="o">+</span> <span class="n">logid</span> <span class="o">+</span> <span class="s">&quot;, {&quot;</span> <span class="o">+</span> <span class="n">work</span><span class="o">.</span><span class="na">op</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">work</span><span class="o">.</span><span class="na">num2</span> <span class="o">+</span> <span class="s">&quot;})&quot;</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">work</span><span class="o">.</span><span class="na">op</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">ADD:</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">+</span> <span class="n">work</span><span class="o">.</span><span class="na">num2</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="nl">SUBTRACT:</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">-</span> <span class="n">work</span><span class="o">.</span><span class="na">num2</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="nl">MULTIPLY:</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">*</span> <span class="n">work</span><span class="o">.</span><span class="na">num2</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">case</span> <span class="nl">DIVIDE:</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">work</span><span class="o">.</span><span class="na">num2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">InvalidOperation</span> <span class="n">io</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvalidOperation</span><span class="o">();</span>
        <span class="n">io</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="na">op</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
        <span class="n">io</span><span class="o">.</span><span class="na">why</span> <span class="o">=</span> <span class="s">&quot;Cannot divide by 0&quot;</span><span class="o">;</span>
        <span class="k">throw</span> <span class="n">io</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">/</span> <span class="n">work</span><span class="o">.</span><span class="na">num2</span><span class="o">;</span>
      <span class="k">break</span><span class="o">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">InvalidOperation</span> <span class="n">io</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvalidOperation</span><span class="o">();</span>
      <span class="n">io</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="na">op</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
      <span class="n">io</span><span class="o">.</span><span class="na">why</span> <span class="o">=</span> <span class="s">&quot;Unknown operation&quot;</span><span class="o">;</span>
      <span class="k">throw</span> <span class="n">io</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">SharedStruct</span> <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SharedStruct</span><span class="o">();</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">logid</span><span class="o">;</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">logid</span><span class="o">,</span> <span class="n">entry</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">val</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">SharedStruct</span> <span class="nf">getStruct</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;getStruct(&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">log</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">zip</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;zip()&quot;</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="java-calculator-server">
<h3>Java Calculator Server<a class="headerlink" href="#java-calculator-server" title="Permalink to this headline">¶</a></h3>
<p>Most of the code for the server remains the same as above. What is added here is the option of a secure server that you can use to provide authenticated service. With comments you can also see what the code for a multi threaded server looks like.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="cm"> * or more contributor license agreements. See the NOTICE file</span>
<span class="cm"> * distributed with this work for additional information</span>
<span class="cm"> * regarding copyright ownership. The ASF licenses this file</span>
<span class="cm"> * to you under the Apache License, Version 2.0 (the</span>
<span class="cm"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span class="cm"> * with the License. You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing,</span>
<span class="cm"> * software distributed under the License is distributed on an</span>
<span class="cm"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="cm"> * KIND, either express or implied. See the License for the</span>
<span class="cm"> * specific language governing permissions and limitations</span>
<span class="cm"> * under the License.</span>
<span class="cm"> */</span>

<span class="kn">import</span> <span class="nn">org.apache.thrift.server.TServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.server.TServer.Args</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.server.TSimpleServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.server.TThreadPoolServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TSSLTransportFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TServerTransport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TSSLTransportFactory.TSSLTransportParameters</span><span class="o">;</span>

<span class="c1">// Generated code</span>
<span class="kn">import</span> <span class="nn">tutorial.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">shared.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaServer</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">CalculatorHandler</span> <span class="n">handler</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Calculator</span><span class="o">.</span><span class="na">Processor</span> <span class="n">processor</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CalculatorHandler</span><span class="o">();</span>
      <span class="n">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calculator</span><span class="o">.</span><span class="na">Processor</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>

      <span class="n">Runnable</span> <span class="n">simple</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">simple</span><span class="o">(</span><span class="n">processor</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">};</span>      
      <span class="n">Runnable</span> <span class="n">secure</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">secure</span><span class="o">(</span><span class="n">processor</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">};</span>

      <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">simple</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
      <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">secure</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">x</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">simple</span><span class="o">(</span><span class="n">Calculator</span><span class="o">.</span><span class="na">Processor</span> <span class="n">processor</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">TServerTransport</span> <span class="n">serverTransport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TServerSocket</span><span class="o">(</span><span class="mi">9090</span><span class="o">);</span>
      <span class="n">TServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSimpleServer</span><span class="o">(</span><span class="k">new</span> <span class="n">Args</span><span class="o">(</span><span class="n">serverTransport</span><span class="o">).</span><span class="na">processor</span><span class="o">(</span><span class="n">processor</span><span class="o">));</span>

      <span class="c1">// Use this for a multithreaded server</span>
      <span class="c1">// TServer server = new TThreadPoolServer(new TThreadPoolServer.Args(serverTransport).processor(processor));</span>

      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Starting the simple server...&quot;</span><span class="o">);</span>
      <span class="n">server</span><span class="o">.</span><span class="na">serve</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">secure</span><span class="o">(</span><span class="n">Calculator</span><span class="o">.</span><span class="na">Processor</span> <span class="n">processor</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="cm">/*</span>
<span class="cm">       * Use TSSLTransportParameters to setup the required SSL parameters. In this example</span>
<span class="cm">       * we are setting the keystore and the keystore password. Other things like algorithms,</span>
<span class="cm">       * cipher suites, client auth etc can be set. </span>
<span class="cm">       */</span>
      <span class="n">TSSLTransportParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSSLTransportParameters</span><span class="o">();</span>
      <span class="c1">// The Keystore contains the private key</span>
      <span class="n">params</span><span class="o">.</span><span class="na">setKeyStore</span><span class="o">(</span><span class="s">&quot;../../lib/java/test/.keystore&quot;</span><span class="o">,</span> <span class="s">&quot;thrift&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

      <span class="cm">/*</span>
<span class="cm">       * Use any of the TSSLTransportFactory to get a server transport with the appropriate</span>
<span class="cm">       * SSL configuration. You can use the default settings if properties are set in the command line.</span>
<span class="cm">       * Ex: -Djavax.net.ssl.keyStore=.keystore and -Djavax.net.ssl.keyStorePassword=thrift</span>
<span class="cm">       * </span>
<span class="cm">       * Note: You need not explicitly call open(). The underlying server socket is bound on return</span>
<span class="cm">       * from the factory class. </span>
<span class="cm">       */</span>
      <span class="n">TServerTransport</span> <span class="n">serverTransport</span> <span class="o">=</span> <span class="n">TSSLTransportFactory</span><span class="o">.</span><span class="na">getServerSocket</span><span class="o">(</span><span class="mi">9091</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
      <span class="n">TServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSimpleServer</span><span class="o">(</span><span class="k">new</span> <span class="n">Args</span><span class="o">(</span><span class="n">serverTransport</span><span class="o">).</span><span class="na">processor</span><span class="o">(</span><span class="n">processor</span><span class="o">));</span>

      <span class="c1">// Use this for a multi threaded server</span>
      <span class="c1">// TServer server = new TThreadPoolServer(new TThreadPoolServer.Args(serverTransport).processor(processor));</span>

      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Starting the secure server...&quot;</span><span class="o">);</span>
      <span class="n">server</span><span class="o">.</span><span class="na">serve</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="java-calculator-client">
<h3>Java Calculator Client<a class="headerlink" href="#java-calculator-client" title="Permalink to this headline">¶</a></h3>
<p>But for the option given to the user to choose between the simple and the secure server nothing changed to the code of the client as well. We simpe call more operations with some additional calls.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Licensed to the Apache Software Foundation (ASF) under one</span>
<span class="cm"> * or more contributor license agreements. See the NOTICE file</span>
<span class="cm"> * distributed with this work for additional information</span>
<span class="cm"> * regarding copyright ownership. The ASF licenses this file</span>
<span class="cm"> * to you under the Apache License, Version 2.0 (the</span>
<span class="cm"> * &quot;License&quot;); you may not use this file except in compliance</span>
<span class="cm"> * with the License. You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing,</span>
<span class="cm"> * software distributed under the License is distributed on an</span>
<span class="cm"> * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span>
<span class="cm"> * KIND, either express or implied. See the License for the</span>
<span class="cm"> * specific language governing permissions and limitations</span>
<span class="cm"> * under the License.</span>
<span class="cm"> */</span>

<span class="c1">// Generated code</span>
<span class="kn">import</span> <span class="nn">tutorial.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">shared.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.thrift.TException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TSSLTransportFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TTransport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.transport.TSSLTransportFactory.TSSLTransportParameters</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.protocol.TBinaryProtocol</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.thrift.protocol.TProtocol</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Please enter &#39;simple&#39; or &#39;secure&#39;&quot;</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="n">TTransport</span> <span class="n">transport</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;simple&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSocket</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">9090</span><span class="o">);</span>
        <span class="n">transport</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Similar to the server, you can use the parameters to setup client parameters or</span>
<span class="cm">         * use the default settings. On the client side, you will need a TrustStore which</span>
<span class="cm">         * contains the trusted certificate along with the public key. </span>
<span class="cm">         * For this example it&#39;s a self-signed cert. </span>
<span class="cm">         */</span>
        <span class="n">TSSLTransportParameters</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TSSLTransportParameters</span><span class="o">();</span>
        <span class="n">params</span><span class="o">.</span><span class="na">setTrustStore</span><span class="o">(</span><span class="s">&quot;../../lib/java/test/.truststore&quot;</span><span class="o">,</span> <span class="s">&quot;thrift&quot;</span><span class="o">,</span> <span class="s">&quot;SunX509&quot;</span><span class="o">,</span> <span class="s">&quot;JKS&quot;</span><span class="o">);</span>
        <span class="cm">/*</span>
<span class="cm">         * Get a client transport instead of a server transport. The connection is opened on</span>
<span class="cm">         * invocation of the factory method, no need to specifically call open()</span>
<span class="cm">         */</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="n">TSSLTransportFactory</span><span class="o">.</span><span class="na">getClientSocket</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">9091</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">TProtocol</span> <span class="n">protocol</span> <span class="o">=</span> <span class="k">new</span>  <span class="n">TBinaryProtocol</span><span class="o">(</span><span class="n">transport</span><span class="o">);</span>
      <span class="n">Calculator</span><span class="o">.</span><span class="na">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calculator</span><span class="o">.</span><span class="na">Client</span><span class="o">(</span><span class="n">protocol</span><span class="o">);</span>

      <span class="n">perform</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>

      <span class="n">transport</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">x</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> 
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">perform</span><span class="o">(</span><span class="n">Calculator</span><span class="o">.</span><span class="na">Client</span> <span class="n">client</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TException</span>
  <span class="o">{</span>
    <span class="n">client</span><span class="o">.</span><span class="na">ping</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;ping()&quot;</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;1+1=&quot;</span> <span class="o">+</span> <span class="n">sum</span><span class="o">);</span>

    <span class="n">Work</span> <span class="n">work</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Work</span><span class="o">();</span>

    <span class="n">work</span><span class="o">.</span><span class="na">op</span> <span class="o">=</span> <span class="n">Operation</span><span class="o">.</span><span class="na">DIVIDE</span><span class="o">;</span>
    <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="n">work</span><span class="o">.</span><span class="na">num2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">quotient</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">calculate</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">work</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Whoa we can divide by 0&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvalidOperation</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Invalid operation: &quot;</span> <span class="o">+</span> <span class="n">io</span><span class="o">.</span><span class="na">why</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">work</span><span class="o">.</span><span class="na">op</span> <span class="o">=</span> <span class="n">Operation</span><span class="o">.</span><span class="na">SUBTRACT</span><span class="o">;</span>
    <span class="n">work</span><span class="o">.</span><span class="na">num1</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>
    <span class="n">work</span><span class="o">.</span><span class="na">num2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">calculate</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">work</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;15-10=&quot;</span> <span class="o">+</span> <span class="n">diff</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvalidOperation</span> <span class="n">io</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Invalid operation: &quot;</span> <span class="o">+</span> <span class="n">io</span><span class="o">.</span><span class="na">why</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">SharedStruct</span> <span class="n">log</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getStruct</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Check log: &quot;</span> <span class="o">+</span> <span class="n">log</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="multiplication-service.html">Thrift&#8217;s auto-generated code for the multiplication service example</a></li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Thrift by Example</a><ul>
<li><a class="reference internal" href="#generating-code-with-thrift">Generating code with Thrift</a></li>
<li><a class="reference internal" href="#a-simple-example-to-warm-up">A Simple Example to warm-up</a><ul>
<li><a class="reference internal" href="#multiplication-handler">Multiplication Handler</a></li>
<li><a class="reference internal" href="#java-multiplication-server">Java Multiplication Server</a></li>
<li><a class="reference internal" href="#java-multiplication-client">Java Multiplication Client</a></li>
<li><a class="reference internal" href="#python-multiplication-client">Python Multiplication Client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-more-complicated-example">A More Complicated Example</a><ul>
<li><a class="reference internal" href="#calculator-service-handler">Calculator Service Handler</a></li>
<li><a class="reference internal" href="#java-calculator-server">Java Calculator Server</a></li>
<li><a class="reference internal" href="#java-calculator-client">Java Calculator Client</a><ul>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="thrift-file.html"
                        title="previous chapter">Writing a .thrift file</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="multiplication-service.html"
                        title="next chapter">Thrift&#8217;s auto-generated code for the multiplication service example</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/usage-example.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="multiplication-service.html" title="Thrift’s auto-generated code for the multiplication service example"
             >next</a> |</li>
        <li class="right" >
          <a href="thrift-file.html" title="Writing a .thrift file"
             >previous</a> |</li>
        <li><a href="index.html">Thrift Tutorial 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Stratos Dimopoulos.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>